{
  "hash": "9d0cff9e4844786ed6c2d6f20bd53d3c",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Hands_on Exercise 4\"\nauthor: \"Xu Haiyang\"\ndate: \"9 September, 2024\" \ndate-modified: \"last-modified\"\nexecute: \n  eval: true\n  echo: true\n  freeze: true\n---\n\n\n## **Overview**\n\nA spatio-temporal point process (also known as a space-time or spatial-temporal point process) is a random collection of points where each point represents the time and location of an event. These events can include disease outbreaks, sightings or births of species, or occurrences of natural disasters like fires, earthquakes, and volcanic eruptions.\n\nWith the growing availability of geographically and temporally indexed data, analyzing spatio-temporal point patterns has become increasingly important in various fields. In this chapter, I will demonstrate how to use different R packages to run spatio-temporal point pattern analyses. The example will focus on forest fire events in Kepulauan Bangka Belitung, Indonesia, from January 1, 2023, to December 31, 2023.\n\n## **The Data**\n\nFor this exercise, I will use two datasets:\n\n1.  **forestfires**: A CSV file containing the locations of forest fires detected by the MODIS sensor. The data is available from the [Fire Information for Resource Management System](https://firms.modaps.eosdis.nasa.gov/download/). I will only use the forest fires within Kepulauan Bangka Belitung.\n\n2.  **Kepulauan_Bangka_Belitung**: An ESRI shapefile containing sub-district boundaries (kelurahan) of Kepulauan Bangka Belitung. The data was downloaded from the [Indonesia Geospatial Portal](https://www.indonesia-geospasial.com/2023/05/download-shapefile-batas-administrasi.html). This shapefile originally covers all of Indonesia, but I will extract only the relevant sub-districts.\n\n## **Installing and Loading the R Packages**\n\nTo begin, I installed and loaded the necessary packages:\n\n\n::: {.cell}\n\n```{.r .cell-code}\npacman::p_load(sf, raster, spatstat, sparr, tmap, tidyverse, animation, magick)\n```\n:::\n\n\n-   **`pacman::p_load()`**: This function ensures that the required packages are installed and loaded if not already available. The key packages used here include:\n\n    -   **`sf`**: For spatial vector data manipulation.\n\n    -   **`raster`**: For raster data manipulation.\n\n    -   **`spatstat`**: For spatial point pattern analysis.\n\n    -   **`sparr`**: For spatio-temporal point pattern analysis.\n\n    -   **`tmap`**: For thematic mapping.\n\n    -   **`tidyverse`**: For data manipulation.\n\n## **Importing and Preparing Study Area**\n\nI imported the shapefile for Kepulauan Bangka Belitung and prepared it for analysis:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkbb <- st_read(dsn = \"data/rawdata\", layer = \"Kepulauan_Bangka_Belitung\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nkbb_sf <- st_read(dsn = \"data/rawdata\", layer = \"Kepulauan_Bangka_Belitung\") %>%\n  st_union() %>%\n  st_zm(drop = TRUE, what = \"ZM\") %>%\n  st_transform(crs = 32748)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `Kepulauan_Bangka_Belitung' from data source \n  `C:\\EasonXu-HY99\\IS415\\Hands-on_Ex\\Hands-on_Ex04\\data\\rawdata' \n  using driver `ESRI Shapefile'\nSimple feature collection with 298 features and 27 fields\nGeometry type: POLYGON\nDimension:     XYZ\nBounding box:  xmin: 105.1085 ymin: -3.116593 xmax: 106.8488 ymax: -1.501603\nz_range:       zmin: 0 zmax: 0\nGeodetic CRS:  WGS 84\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nst_as_s2(): dropping Z and/or M coordinate\n```\n\n\n:::\n:::\n\n\n-   **Why**: I unioned and transformed the spatial data into the appropriate coordinate reference system (EPSG: 32748) to ensure consistency with the fire data.\n\n-   **Functions**:\n\n    -   **`st_union()`**: Combines geometries into a single geometry.\n\n    -   **`st_zm()`**: Removes Z (elevation) and M (measure) dimensions if present.\n\n    -   **`st_transform()`**: Projects the spatial data to the specified CRS.\n\nNext, I converted the spatial data into an observation window for further analysis:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkbb_owin <- as.owin(kbb_sf)\nkbb_owin\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nwindow: polygonal boundary\nenclosing rectangle: [512066.8, 705559.4] x [9655398, 9834006] units\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nclass(kbb_owin)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"owin\"\n```\n\n\n:::\n:::\n\n\n-   **Why**: Converting the shapefile into an `owin` object allows it to be used in point pattern analysis.\n\n-   **Functions**:\n\n    -   **`as.owin()`**: Converts the spatial object into a window object for use with the `spatstat` package.\n\n## **Importing and Preparing Forest Fire Data**\n\nI imported the forest fire data from a CSV file and transformed it into an `sf` object:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfire_sf <- read_csv(\"data/rawdata/forestfires.csv\") %>%\n  st_as_sf(coords = c(\"longitude\", \"latitude\"), crs = 4326) %>%\n  st_transform(crs = 32748)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nRows: 741 Columns: 15\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \",\"\nchr   (3): satellite, instrument, daynight\ndbl  (11): latitude, longitude, brightness, scan, track, acq_time, confidenc...\ndate  (1): acq_date\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n```\n\n\n:::\n:::\n\n\n-   **Why**: The forest fire data is converted into an `sf` object for spatial analysis and then projected to the same CRS as the study area.\n\n-   **Functions**:\n\n    -   **`read_csv()`**: Reads CSV data into a data frame.\n\n    -   **`st_as_sf()`**: Converts the data frame into an `sf` object using the longitude and latitude columns as coordinates.\n\n### Handling Date Data\n\nI extracted additional information from the date column:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfire_sf <- fire_sf %>%\n  mutate(DayofYear = yday(acq_date)) %>%\n  mutate(Month_num = month(acq_date)) %>%\n  mutate(Month_fac = month(acq_date, label = TRUE, abbr = FALSE))\n```\n:::\n\n\n-   **Why**: I extracted the day of the year and month from the acquisition date to facilitate monthly and day-based analysis.\n\n-   **Functions**:\n\n    -   **`yday()`**: Extracts the day of the year from a date.\n\n    -   **`month()`**: Extracts the month from a date, with an option for labeled months.\n\n## **Visualizing the Fire Points**\n\nTo visualize the fire points over the study area:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntm_shape(kbb_sf) + tm_polygons() + tm_shape(fire_sf) + tm_dots()\n```\n\n::: {.cell-output-display}\n![](Hands-on_Ex04_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n-   **Why**: This basic visualization helps confirm that the fire points are correctly aligned with the study area.\n\nNext, I created a faceted map showing the fire points by month:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntm_shape(kbb_sf) + tm_polygons() + tm_shape(fire_sf) + tm_dots(size = 0.1) + tm_facets(by = \"Month_fac\", free.coords = FALSE, drop.units = TRUE)\n```\n\n::: {.cell-output-display}\n![](Hands-on_Ex04_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n-   **Why**: Faceted maps display fire points month by month, revealing temporal patterns in the fire events.\n\n## **Extracting and Creating Point Pattern Object**\n\nI extracted the fire events by month:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfire_month <- fire_sf %>%\n  select(Month_num)\n```\n:::\n\n\nThen, I created a point pattern object (`ppp`) for the fire events:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfire_month_ppp <- as.ppp(fire_month)\nfire_month_ppp\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nMarked planar point pattern: 741 points\nmarks are numeric, of storage type  'double'\nwindow: rectangle = [521564.1, 695791] x [9658137, 9828767] units\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(fire_month_ppp)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nMarked planar point pattern:  741 points\nAverage intensity 2.49258e-08 points per square unit\n\nCoordinates are given to 10 decimal places\n\nmarks are numeric, of type 'double'\nSummary:\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n  1.000   8.000   9.000   8.579  10.000  12.000 \n\nWindow: rectangle = [521564.1, 695791] x [9658137, 9828767] units\n                    (174200 x 170600 units)\nWindow area = 29728200000 square units\n```\n\n\n:::\n:::\n\n\n-   **Why**: Creating a `ppp` object allows me to analyze the fire events using spatial point pattern methods.\n\n-   **Functions**:\n\n    -   **`as.ppp()`**: Converts an `sf` object into a point pattern object.\n\n    -   **`summary()`**: Provides a summary of the point pattern object, including the number of points and window properties.\n\nChecking for duplicate points:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nany(duplicated(fire_month_ppp))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] FALSE\n```\n\n\n:::\n:::\n\n\nIncluding the observation window:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfire_month_owin <- fire_month_ppp[kbb_owin]\nsummary(fire_month_owin)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nMarked planar point pattern:  741 points\nAverage intensity 6.424519e-08 points per square unit\n\nCoordinates are given to 10 decimal places\n\nmarks are numeric, of type 'double'\nSummary:\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n  1.000   8.000   9.000   8.579  10.000  12.000 \n\nWindow: polygonal boundary\n2 separate polygons (no holes)\n           vertices        area relative.area\npolygon 1     47493 11533600000      1.00e+00\npolygon 2       256      306427      2.66e-05\nenclosing rectangle: [512066.8, 705559.4] x [9655398, 9834006] units\n                     (193500 x 178600 units)\nWindow area = 11533900000 square units\nFraction of frame area: 0.334\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(fire_month_owin)\n```\n\n::: {.cell-output-display}\n![](Hands-on_Ex04_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\n## **Computing Spatio-Temporal KDE**\n\nI computed the spatio-temporal kernel density estimation (STKDE) for the fire events:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nst_kde <- spattemp.density(fire_month_owin)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nCalculating trivariate smooth...Done.\nEdge-correcting...Done.\nConditioning on time...Done.\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(st_kde)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSpatiotemporal Kernel Density Estimate\n\nBandwidths\n  h = 15102.47 (spatial)\n  lambda = 0.0304 (temporal)\n\nNo. of observations\n  741 \n\nSpatial bound\n  Type: polygonal\n  2D enclosure: [512066.8, 705559.4] x [9655398, 9834006]\n\nTemporal bound\n  [1, 12]\n\nEvaluation\n  128 x 128 x 12 trivariate lattice\n  Density range: [1.233458e-27, 8.202976e-10]\n```\n\n\n:::\n:::\n\n\n-   **Why**: STKDE estimates the intensity of fire events over time and space, revealing spatio-temporal patterns in the data.\n\n-   **Functions**:\n\n    -   **`spattemp.density()`**: Computes spatio-temporal kernel density estimation.\n\n### Plotting the Spatio-Temporal KDE Object\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntims <- c(7,8,9,10,11,12)\npar(mfcol = c(2,3))\nfor(i in tims)(\n  plot(st_kde, i,\n       override.par=FALSE,\n       fix.range=TRUE,\n       main=paste(\"KDE at month\", i))\n)\n```\n\n::: {.cell-output-display}\n![](Hands-on_Ex04_files/figure-html/unnamed-chunk-17-1.png){width=1152}\n:::\n:::\n\n\n-   **Why**: This loop plots the STKDE results for selected months, helping to visualize the intensity of fire events across different time periods.\n\n## **Computing STKDE by Day of Year**\n\nI repeated the STKDE analysis by day of the year:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfire_yday_ppp <- fire_sf %>%\n  select(DayofYear) %>%\n  as.ppp()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nfire_yday_owin <- fire_yday_ppp[kbb_owin]\nsummary(fire_yday_owin)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nMarked planar point pattern:  741 points\nAverage intensity 6.424519e-08 points per square unit\n\nCoordinates are given to 10 decimal places\n\nmarks are numeric, of type 'double'\nSummary:\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n   10.0   213.0   258.0   245.9   287.0   352.0 \n\nWindow: polygonal boundary\n2 separate polygons (no holes)\n           vertices        area relative.area\npolygon 1     47493 11533600000      1.00e+00\npolygon 2       256      306427      2.66e-05\nenclosing rectangle: [512066.8, 705559.4] x [9655398, 9834006] units\n                     (193500 x 178600 units)\nWindow area = 11533900000 square units\nFraction of frame area: 0.334\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nkde_yday <- spattemp.density(\n  fire_yday_owin)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nCalculating trivariate smooth...Done.\nEdge-correcting...Done.\nConditioning on time...Done.\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(kde_yday)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSpatiotemporal Kernel Density Estimate\n\nBandwidths\n  h = 15102.47 (spatial)\n  lambda = 6.3198 (temporal)\n\nNo. of observations\n  741 \n\nSpatial bound\n  Type: polygonal\n  2D enclosure: [512066.8, 705559.4] x [9655398, 9834006]\n\nTemporal bound\n  [10, 352]\n\nEvaluation\n  128 x 128 x 343 trivariate lattice\n  Density range: [3.959516e-27, 2.751287e-12]\n```\n\n\n:::\n:::\n\n\n-   **Why**: This analysis provides a finer temporal resolution of the fire events, revealing how fire intensity changes throughout the year.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsaveGIF({\n  for (i in 10:352) {  \n    plot(kde_yday, tselect = i)  \n  }\n}, movie.name = \"kde_yday.gif\", interval = 0.1)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nOutput at: kde_yday.gif\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] TRUE\n```\n\n\n:::\n\n```{.r .cell-code}\ngif <- image_read(\"kde_yday.gif\")\n\nprint(gif)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 343 × 7\n   format width height colorspace matte filesize density\n   <chr>  <int>  <int> <chr>      <lgl>    <int> <chr>  \n 1 GIF      480    480 sRGB       FALSE        0 72x72  \n 2 GIF      480    480 sRGB       FALSE        0 72x72  \n 3 GIF      480    480 sRGB       FALSE        0 72x72  \n 4 GIF      480    480 sRGB       FALSE        0 72x72  \n 5 GIF      480    480 sRGB       FALSE        0 72x72  \n 6 GIF      480    480 sRGB       FALSE        0 72x72  \n 7 GIF      480    480 sRGB       FALSE        0 72x72  \n 8 GIF      480    480 sRGB       FALSE        0 72x72  \n 9 GIF      480    480 sRGB       FALSE        0 72x72  \n10 GIF      480    480 sRGB       FALSE        0 72x72  \n# ℹ 333 more rows\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](Hands-on_Ex04_files/figure-html/unnamed-chunk-21-1.gif)\n:::\n:::\n",
    "supporting": [
      "Hands-on_Ex04_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}